---
title: "Assignment B-1: Making a function"
output: github_document
---

## Getting Started

```{r}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(testthat))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(gapminder))
suppressPackageStartupMessages(library(broom))
suppressPackageStartupMessages(library(datateachr))
```

## Exercise 1: Make a Function

```{r}
#' @title Percentage by Group
#' @details
#' Summarize the percentage of rows that satisfies given condition(s) by group
#'
#' @param .data A data frame, data frame extension (e.g. a tibble), or a lazy data frame (e.g. from dbplyr or dtplyr).
#' @param group_by_cols Column names or ids to group the rows
#' @param conditions Conditions that a row should satisfy to be considered in percentage calculation
#' @return A summarized dataframe with all combinations of group_by_cols and a new column "percentage"
percentage_by_group <- function(.data, group_by_cols, conditions = TRUE) {
    stopifnot(is.data.frame(.data))
    if(is.numeric(group_by_cols)) {
        stopifnot(floor(group_by_cols) == group_by_cols)
    }
    .data %>%
    drop_na(all_of(group_by_cols)) %>%
    group_by(across(all_of(group_by_cols))) %>%
    summarise(percentage = round(sum({{conditions}}) / n(), digits=2))
}
```

## Exercise 2: Document your Function
See above.

## Exercise 3: Include examples
Calculate the percentage of buildings that has a sprinkler system by year:
```{r}
apt_buildings %>%
    filter(year_built >= 1950) %>%
    drop_na(sprinkler_system) %>%
    percentage_by_group('year_built', sprinkler_system == "YES")
```

Calculate the percentage of buildings that has at least 5 floors by year and property type:
```{r}
apt_buildings %>%
    filter(year_built >= 1950) %>%
    drop_na(year_built) %>%
    percentage_by_group(c('year_built', 'property_type'), no_of_storeys >= 5)
```

## Exercise 4: Test the Function
First, sample a small data frame for testing:
```{r}
set.seed(123)
apt_buildings_small <- apt_buildings %>%
    filter(year_built >= 1955, year_built < 1960) %>%
    sample_n(50)
head(apt_buildings_small)
```

Test with no NA’s:
```{r}
result <- apt_buildings_small %>%
    percentage_by_group('year_built',
    !is.na(sprinkler_system) & sprinkler_system == "YES")
expected <- as_tibble(data.frame(
    year_built = c(1955, 1956, 1957, 1958, 1959),
    percentage = c(0.43, 0.25, 0.62, 0.64, 0.6))
)
test_that("Test with no NA’s", {
    expect_identical(result, expected)
})
```

Test with NA’s:
```{r}
apt_buildings_small[nrow(apt_buildings_small) + 1, ] <- NA # year_built column will have a NA value
result <- apt_buildings_small %>%
    percentage_by_group('year_built',
    !is.na(sprinkler_system) & sprinkler_system == "YES")
test_that("Test with NA’s", {
    expect_identical(result, expected)
})
```

Test with different type:
```{r}
test_that("Test with different type", {
    expect_error(
        apt_buildings_small %>%
            percentage_by_group(c(1.1, 2, 3),
            !is.na(sprinkler_system) & sprinkler_system == "YES")
    )
})
```